!function(e,t,r){"function"==typeof define_?define_(t):"undefined"!=typeof module&&module.exports?module.exports=t():r[e]=t()}("IDBStore",function(){var e=function(e){throw e},t=function(){},r={storeName:"Store",storePrefix:"IDBWrapper-",dbVersion:1,keyPath:"id",autoIncrement:!0,onStoreReady:function(){},onError:e,indexes:[]},n=function(e,t){"undefined"==typeof t&&"function"==typeof e&&(t=e),"[object Object]"!=Object.prototype.toString.call(e)&&(e={});for(var n in r)this[n]="undefined"!=typeof e[n]?e[n]:r[n];this.dbName=this.storePrefix+this.storeName,this.dbVersion=parseInt(this.dbVersion,10)||1,t&&(this.onStoreReady=t),n="object"==typeof window?window:self,this.idb=n.shimIndexedDB||n.indexedDB||n.webkitIndexedDB||n.mozIndexedDB,this.keyRange=n.IDBKeyRange||n.webkitIDBKeyRange||n.mozIDBKeyRange,this.consts={READ_ONLY:"readonly",READ_WRITE:"readwrite",VERSION_CHANGE:"versionchange",NEXT:"next",NEXT_NO_DUPLICATE:"nextunique",PREV:"prev",PREV_NO_DUPLICATE:"prevunique"},this.openDB()};n.prototype={constructor:n,version:"1.6.0",db:null,dbName:null,dbVersion:null,store:null,storeName:null,storePrefix:null,keyPath:null,autoIncrement:null,indexes:null,onStoreReady:null,onError:null,_insertIdCount:0,openDB:function(){var e=this.idb.open(this.dbName,this.dbVersion),t=!1;e.onerror=function(e){var t=!1;"error"in e.target?t="VersionError"==e.target.error.name:"errorCode"in e.target&&(t=12==e.target.errorCode),t?this.onError(Error("The version number provided is lower than the existing one.")):this.onError(e)}.bind(this),e.onsuccess=function(e){if(!t)if(this.db)this.onStoreReady();else if(this.db=e.target.result,"string"==typeof this.db.version)this.onError(Error("The IndexedDB implementation in this browser is outdated. Please upgrade your browser."));else if(this.db.objectStoreNames.contains(this.storeName)){this.store=this.db.transaction([this.storeName],this.consts.READ_ONLY).objectStore(this.storeName);var r=Array.prototype.slice.call(this.getIndexList());this.indexes.forEach(function(e){var n=e.name;n?(this.normalizeIndexData(e),this.hasIndex(n)?(this.indexComplies(this.store.index(n),e)||(t=!0,this.onError(Error('Cannot modify index "'+n+'" for current version. Please bump version number to '+(this.dbVersion+1)+"."))),r.splice(r.indexOf(n),1)):(t=!0,this.onError(Error('Cannot create new index "'+n+'" for current version. Please bump version number to '+(this.dbVersion+1)+".")))):(t=!0,this.onError(Error("Cannot create index: No index name given.")))},this),r.length&&(t=!0,this.onError(Error('Cannot delete index(es) "'+r.toString()+'" for current version. Please bump version number to '+(this.dbVersion+1)+"."))),t||this.onStoreReady()}else this.onError(Error("Something is wrong with the IndexedDB implementation in this browser. Please upgrade your browser."))}.bind(this),e.onupgradeneeded=function(e){this.db=e.target.result,this.db.objectStoreNames.contains(this.storeName)?this.store=e.target.transaction.objectStore(this.storeName):(e={autoIncrement:this.autoIncrement},null!==this.keyPath&&(e.keyPath=this.keyPath),this.store=this.db.createObjectStore(this.storeName,e));var r=Array.prototype.slice.call(this.getIndexList());this.indexes.forEach(function(e){var n=e.name;n||(t=!0,this.onError(Error("Cannot create index: No index name given."))),this.normalizeIndexData(e),this.hasIndex(n)?(this.indexComplies(this.store.index(n),e)||(this.store.deleteIndex(n),this.store.createIndex(n,e.keyPath,{unique:e.unique,multiEntry:e.multiEntry})),r.splice(r.indexOf(n),1)):this.store.createIndex(n,e.keyPath,{unique:e.unique,multiEntry:e.multiEntry})},this),r.length&&r.forEach(function(e){this.store.deleteIndex(e)},this)}.bind(this)},deleteDatabase:function(e,t){if(this.idb.deleteDatabase){this.db.close();var r=this.idb.deleteDatabase(this.dbName);r.onsuccess=e,r.onerror=t}else t(Error("Browser does not support IndexedDB deleteDatabase!"))},put:function(r,n,o,i){null!==this.keyPath&&(i=o,o=n,n=r),i||(i=e),o||(o=t);var s=!1,a=null,u=this.db.transaction([this.storeName],this.consts.READ_WRITE);return u.oncomplete=function(){(s?o:i)(a)},u.onabort=i,u.onerror=i,null!==this.keyPath?(this._addIdPropertyIfNeeded(n),r=u.objectStore(this.storeName).put(n)):r=u.objectStore(this.storeName).put(n,r),r.onsuccess=function(e){s=!0,a=e.target.result},r.onerror=i,u},get:function(r,n,o){o||(o=e),n||(n=t);var i=!1,s=null,a=this.db.transaction([this.storeName],this.consts.READ_ONLY);return a.oncomplete=function(){(i?n:o)(s)},a.onabort=o,a.onerror=o,r=a.objectStore(this.storeName).get(r),r.onsuccess=function(e){i=!0,s=e.target.result},r.onerror=o,a},remove:function(r,n,o){o||(o=e),n||(n=t);var i=!1,s=null,a=this.db.transaction([this.storeName],this.consts.READ_WRITE);return a.oncomplete=function(){(i?n:o)(s)},a.onabort=o,a.onerror=o,r=a.objectStore(this.storeName)["delete"](r),r.onsuccess=function(e){i=!0,s=e.target.result},r.onerror=o,a},batch:function(r,n,o){if(o||(o=e),n||(n=t),"[object Array]"!=Object.prototype.toString.call(r))o(Error("dataArray argument must be of type Array."));else if(0===r.length)return n(!0);var i=this.db.transaction([this.storeName],this.consts.READ_WRITE);i.oncomplete=function(){(u?n:o)(u)},i.onabort=o,i.onerror=o;var s=r.length,a=!1,u=!1,c=function(){s--,0===s&&!a&&(u=a=!0)};return r.forEach(function(e){var t=e.type,r=e.key,n=e.value,e=function(e){i.abort(),a||(a=!0,o(e,t,r))};"remove"==t?(n=i.objectStore(this.storeName)["delete"](r),n.onsuccess=c,n.onerror=e):"put"==t&&(null!==this.keyPath?(this._addIdPropertyIfNeeded(n),n=i.objectStore(this.storeName).put(n)):n=i.objectStore(this.storeName).put(n,r),n.onsuccess=c,n.onerror=e)},this),i},putBatch:function(e,t,r){return this.batch(e.map(function(e){return{type:"put",value:e}}),t,r)},upsertBatch:function(r,n,o,i){"function"==typeof n&&(i=o=n,n={}),i||(i=e),o||(o=t),n||(n={}),"[object Array]"!=Object.prototype.toString.call(r)&&i(Error("dataArray argument must be of type Array."));var s=this.db.transaction([this.storeName],this.consts.READ_WRITE);s.oncomplete=function(){h?o(r):i(!1)},s.onabort=i,s.onerror=i;var a=n.keyField||this.keyPath,u=r.length,c=!1,h=!1,l=0,d=function(e){r[l++][a]=e.target.result,u--,0===u&&!c&&(h=c=!0)};return r.forEach(function(e){var t=e.key;null!==this.keyPath?(this._addIdPropertyIfNeeded(e),e=s.objectStore(this.storeName).put(e)):e=s.objectStore(this.storeName).put(e,t),e.onsuccess=d,e.onerror=function(e){s.abort(),c||(c=!0,i(e))}},this),s},removeBatch:function(e,t,r){return this.batch(e.map(function(e){return{type:"remove",key:e}}),t,r)},getBatch:function(r,n,o,i){if(o||(o=e),n||(n=t),i||(i="sparse"),"[object Array]"!=Object.prototype.toString.call(r))o(Error("keyArray argument must be of type Array."));else if(0===r.length)return n([]);var s=this.db.transaction([this.storeName],this.consts.READ_ONLY);s.oncomplete=function(){(c?n:o)(h)},s.onabort=o,s.onerror=o;var a=[],u=r.length,c=!1,h=null,l=function(e){e.target.result||"dense"==i?a.push(e.target.result):"sparse"==i&&a.length++,u--,0===u&&(c=!0,h=a)};return r.forEach(function(e){e=s.objectStore(this.storeName).get(e),e.onsuccess=l,e.onerror=function(e){h=e,o(e),s.abort()}},this),s},getAll:function(r,n){n||(n=e),r||(r=t);var o=this.db.transaction([this.storeName],this.consts.READ_ONLY),i=o.objectStore(this.storeName);return i.getAll?this._getAllNative(o,i,r,n):this._getAllCursor(o,i,r,n),o},_getAllNative:function(e,t,r,n){var o=!1,i=null;e.oncomplete=function(){(o?r:n)(i)},e.onabort=n,e.onerror=n,e=t.getAll(),e.onsuccess=function(e){o=!0,i=e.target.result},e.onerror=n},_getAllCursor:function(e,t,r,n){var o=[],i=!1,s=null;e.oncomplete=function(){(i?r:n)(s)},e.onabort=n,e.onerror=n,e=t.openCursor(),e.onsuccess=function(e){(e=e.target.result)?(o.push(e.value),e["continue"]()):(i=!0,s=o)},e.onError=n},clear:function(r,n){n||(n=e),r||(r=t);var o=!1,i=null,s=this.db.transaction([this.storeName],this.consts.READ_WRITE);s.oncomplete=function(){(o?r:n)(i)},s.onabort=n,s.onerror=n;var a=s.objectStore(this.storeName).clear();return a.onsuccess=function(e){o=!0,i=e.target.result},a.onerror=n,s},_addIdPropertyIfNeeded:function(e){"undefined"==typeof e[this.keyPath]&&(e[this.keyPath]=this._insertIdCount++ +Date.now())},getIndexList:function(){return this.store.indexNames},hasIndex:function(e){return this.store.indexNames.contains(e)},normalizeIndexData:function(e){e.keyPath=e.keyPath||e.name,e.unique=!!e.unique,e.multiEntry=!!e.multiEntry},indexComplies:function(e,t){return["keyPath","unique","multiEntry"].every(function(r){if("multiEntry"==r&&void 0===e[r]&&!1===t[r])return!0;if("keyPath"==r&&"[object Array]"==Object.prototype.toString.call(t[r])){var r=t.keyPath,n=e.keyPath;if("string"==typeof n)return r.toString()==n;if("function"!=typeof n.contains&&"function"!=typeof n.indexOf||n.length!==r.length)return!1;for(var o=0,i=r.length;i>o;o++)if(!(n.contains&&n.contains(r[o])||n.indexOf(-1!==r[o])))return!1;return!0}return t[r]==e[r]})},iterate:function(t,r){var r=i({index:null,order:"ASC",autoContinue:!0,filterDuplicates:!1,keyRange:null,writeAccess:!1,onEnd:null,onError:e,limit:1/0,offset:0},r||{}),n="desc"==r.order.toLowerCase()?"PREV":"NEXT";r.filterDuplicates&&(n+="_NO_DUPLICATE");var o=!1,s=this.db.transaction([this.storeName],this.consts[r.writeAccess?"READ_WRITE":"READ_ONLY"]),a=s.objectStore(this.storeName);r.index&&(a=a.index(r.index));var u=0;return s.oncomplete=function(){o?r.onEnd?r.onEnd():t(null):r.onError(null)},s.onabort=r.onError,s.onerror=r.onError,n=a.openCursor(r.keyRange,this.consts[n]),n.onerror=r.onError,n.onsuccess=function(e){(e=e.target.result)?r.offset?(e.advance(r.offset),r.offset=0):(t(e.value,e,s),u++,r.autoContinue&&(u+r.offset<r.limit?e["continue"]():o=!0)):o=!0},s},query:function(e,t){var r=[],t=t||{};return t.autoContinue=!0,t.writeAccess=!1,t.onEnd=function(){e(r)},this.iterate(function(e){r.push(e)},t)},count:function(t,r){var r=i({index:null,keyRange:null},r||{}),n=r.onError||e,o=!1,s=null,a=this.db.transaction([this.storeName],this.consts.READ_ONLY);a.oncomplete=function(){(o?t:n)(s)},a.onabort=n,a.onerror=n;var u=a.objectStore(this.storeName);return r.index&&(u=u.index(r.index)),u=u.count(r.keyRange),u.onsuccess=function(e){o=!0,s=e.target.result},u.onError=n,a},makeKeyRange:function(e){var t="undefined"!=typeof e.lower,r="undefined"!=typeof e.upper,n="undefined"!=typeof e.only;switch(!0){case n:e=this.keyRange.only(e.only);break;case t&&r:e=this.keyRange.bound(e.lower,e.upper,e.excludeLower,e.excludeUpper);break;case t:e=this.keyRange.lowerBound(e.lower,e.excludeLower);break;case r:e=this.keyRange.upperBound(e.upper,e.excludeUpper);break;default:throw Error('Cannot create KeyRange. Provide one or both of "lower" or "upper" value, or an "only" value.')}return e}};var o={},i=function(e,t){var r,n;for(r in t)n=t[r],n!==o[r]&&n!==e[r]&&(e[r]=n);return e};return n.version=n.prototype.version,n},this),define(function(e){return IDBStore});